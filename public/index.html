<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Prompt Manager</title>

  <style>
    /* ‚îÄ‚îÄ‚îÄ Simple dark theme ‚îÄ‚îÄ‚îÄ */
    :root{
      --bg:#0a0a0a; --panel:#141414; --accent:#667eea; --text:#e0e0e0;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif}
    body{display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--text)}
    header{background:#000;padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
    header span:first-child{font-size:20px;font-weight:600}
    /* layout */
    .app{flex:1;display:flex;min-height:0}
    aside{width:260px;background:var(--panel);padding:20px;overflow-y:auto}
    main{flex:1;display:flex;flex-direction:column;padding:20px;overflow-y:auto}
    /* directory tree */
    .directory-item{display:flex;gap:8px;align-items:center;padding:8px 12px;margin-bottom:4px;border-radius:6px;cursor:pointer;transition:.2s}
    .directory-item:hover{background:#1e1e1e}
    .directory-item.active{background:rgba(102,126,234,.2);border-left:3px solid var(--accent)}
    .sub-directory{margin-left:18px;margin-top:2px}
    /* prompt cards */
    .prompt-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px}
    .prompt-card{background:var(--panel);padding:14px;border-radius:8px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between;transition:transform .2s;cursor:grab}
    .prompt-card:hover{transform:translateY(-4px)}
    .prompt-title{font-weight:600;margin-bottom:8px}
    .prompt-actions{display:flex;gap:6px;margin-top:10px}
    /* buttons / inputs */
    button,input[type=submit]{background:var(--accent);border:none;border-radius:6px;color:#fff;padding:8px 12px;cursor:pointer}
    button.small{padding:4px 6px;font-size:12px}
    dialog{border:none;border-radius:10px;background:var(--panel);color:var(--text);padding:20px}
    dialog input,dialog textarea,dialog select{width:100%;padding:8px;margin-bottom:12px;border:none;border-radius:6px;background:#1e1e1e;color:var(--text)}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <span>Prompt Manager</span>
    <div id="userSection">
      <span id="userEmail"></span>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- LOGIN (shown first) -->
  <dialog id="loginModal" open>
    <h2>Login</h2>
    <input id="loginEmail" type="email"  placeholder="Email"/>
    <input id="loginPassword" type="password" placeholder="Password"/>
    <button onclick="login()">Login / Register</button>
  </dialog>

  <!-- MAIN-APP -->
  <div id="appContainer" class="app hidden">
    <aside>
      <button style="width:100%;margin-bottom:12px" onclick="showNewFolderModal()">+ New Folder</button>
      <div id="directoryTree"></div>
    </aside>

    <main>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button onclick="showNewPromptModal()">+ New Prompt</button>
        <select id="directoryFilter" onchange="changeDirectory(this.value)"></select>
      </div>
      <div id="promptGrid" class="prompt-grid"></div>
    </main>
  </div>

  <!-- PROMPT MODAL -->
  <dialog id="promptModal">
    <h2 id="promptModalTitle">New Prompt</h2>
    <input    id="promptTitle"    placeholder="Title"/>
    <textarea id="promptContent"  rows="6" placeholder="Prompt text‚Ä¶"></textarea>
    <select   id="promptDirectory"></select>
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="promptRestricted"/> Restrict (admin)
    </label>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button onclick="promptModal.close()">Cancel</button>
      <button id="promptModalSave">Save</button>
    </div>
  </dialog>

  <!-- FOLDER MODAL -->
  <dialog id="folderModal">
    <h2>New Folder</h2>
    <input  id="folderName"        placeholder="Folder name"/>
    <select id="parentDirectory"></select>
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="folderShared"/> Shared
    </label>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button onclick="folderModal.close()">Cancel</button>
      <button onclick="createFolder()">Create</button>
    </div>
  </dialog>

  <script>
  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  GLOBAL STATE  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  let authToken      = localStorage.getItem('token');
  let currentUser    = JSON.parse(localStorage.getItem('user')||null);
  let directories    = [];
  let currentDirectory = 'all';     // 'all' | 'shared' | directoryId

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  API HELPER  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  async function apiCall(url,opt={}){
    opt.headers = opt.headers || {};
    opt.headers['Content-Type']='application/json';
    if(authToken) opt.headers.Authorization='Bearer '+authToken;
    const res = await fetch(url,opt);
    if(res.status===401 || res.status===403){ logout(); throw new Error('Auth'); }
    return res;
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  AUTH  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  async function login(){
    const email    = loginEmail.value.trim();
    const password = loginPassword.value.trim();
    if(!email||!password) return alert('Email & password please');
    const res  = await apiCall('/api/login',{method:'POST',body:JSON.stringify({email,password})});
    const data = await res.json();
    if(!res.ok) return alert(data.error||'Login failed');

    authToken   = data.token;
    currentUser = data.user;
    localStorage.setItem('token',authToken);
    localStorage.setItem('user', JSON.stringify(currentUser));

    loginModal.close();
    appContainer.classList.remove('hidden');
    userEmail.textContent=currentUser.email;

    await loadDirectories();
    await loadPrompts();
  }
  function logout(){ localStorage.clear(); location.reload(); }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  DIRECTORY LOGIC  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function buildDirTree(list,parent=null){
    return list.filter(d=>d.parent_id===parent).map(d=>{
      const kids=buildDirTree(list,d.id).join('');
      return `
        <div class="directory-item" data-id="${d.id}"
             draggable="true" ondragover="event.preventDefault()"
             ondrop="handleDrop(event,${d.id})"
             onclick="selectDirectory(this,${d.id})">
          <span class="directory-icon">${d.is_shared?'üë•':'üìÅ'}</span>
          <span>${d.name}</span>
          <button class="small" style="margin-left:auto"
                  onclick="event.stopPropagation();deleteDirectory(${d.id})">üóëÔ∏è</button>
        </div>${kids?`<div class="sub-directory">${kids}</div>`:''}`;
    });
  }
  function renderDirectoryTree(){
    directoryTree.innerHTML = `
      <div class="directory-item ${currentDirectory==='all'?'active':''}"
           onclick="selectDirectory(this,'all')">üìö All Prompts</div>
      ${buildDirTree(directories).join('')}
      <div class="directory-item ${currentDirectory==='shared'?'active':''}"
           onclick="selectDirectory(this,'shared')">üë• Shared Prompts</div>`;
  }

  async function loadDirectories(){
    const res = await apiCall('/api/directories');
    directories = await res.json();
    renderDirectoryTree();
    updateDirectoryDropdowns();
  }

  function updateDirectoryDropdowns(){
    promptDirectory.innerHTML='';
    parentDirectory.innerHTML='<option value="">‚Äî None ‚Äî</option>';
    directories.forEach(d=>{
      promptDirectory.appendChild(new Option(d.name,d.id));
      parentDirectory.appendChild(new Option(d.name,d.id));
    });

    directoryFilter.innerHTML=
      '<option value=\"all\">All</option><option value=\"shared\">Shared</option>';
    directories.forEach(d=>directoryFilter.appendChild(new Option(d.name,d.id)));
    directoryFilter.value=currentDirectory;
  }

  function selectDirectory(el,id){
    document.querySelectorAll('.directory-item').forEach(i=>i.classList.remove('active'));
    el.classList.add('active');
    currentDirectory=id;
    directoryFilter.value=id;
    loadPrompts();
  }
  function changeDirectory(val){
    currentDirectory = val==='all'?'all':(val==='shared'?'shared':parseInt(val));
    renderDirectoryTree();
    loadPrompts();
  }

  async function createFolder(){
    const name       = folderName.value.trim();
    const parent_id  = parentDirectory.value || null;
    const is_shared  = folderShared.checked;
    if(!name) return alert('Folder name?');
    await apiCall('/api/directories',{method:'POST',
      body:JSON.stringify({name,parent_id,is_shared})});
    folderModal.close();
    await loadDirectories();
  }
  async function deleteDirectory(id){
    if(!confirm('Delete this folder and everything inside?')) return;
    await apiCall('/api/directories/'+id,{method:'DELETE'});
    await loadDirectories();
    loadPrompts();
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  PROMPTS  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function card(p){
    const div=document.createElement('div');
    div.className='prompt-card';
    div.draggable=true;
    div.ondragstart=e=>handleDragStart(e,p.id);
    div.innerHTML=`
      <div>
        <div class="prompt-title">${p.title}</div>
        <div style="white-space:pre-line;font-size:14px;opacity:.8">
          ${p.content.slice(0,120)}${p.content.length>120?'‚Ä¶':''}
        </div>
      </div>
      <div class="prompt-actions">
        <button class="small" onclick="editPrompt(${p.id})">‚úèÔ∏è</button>
        <button class="small" onclick="deletePrompt(${p.id})">üóëÔ∏è</button>
      </div>`;
    return div;
  }
  async function loadPrompts(){
    promptGrid.textContent='Loading‚Ä¶';
    const qs=new URLSearchParams();
    if(currentDirectory==='shared') qs.append('shared_only','true');
    else if(currentDirectory!=='all') qs.append('directory_id',currentDirectory);
    const res = await apiCall('/api/prompts?'+qs.toString());
    const list=await res.json();
    promptGrid.innerHTML='';
    list.forEach(p=>promptGrid.appendChild(card(p)));
  }

  async function savePrompt(id=null){
    const body=JSON.stringify({
      title        : promptTitle.value.trim(),
      content      : promptContent.value.trim(),
      directory_id : promptDirectory.value,
      is_restricted: promptRestricted.checked
    });
    let res;
    if(id){
      res=await apiCall('/api/prompts/'+id,{method:'PUT',body});
    }else{
      res=await apiCall('/api/prompts',{method:'POST',body});
    }
    if(!res.ok) return alert('Error saving');
    promptModal.close(); loadPrompts();
  }
  async function deletePrompt(id){
    if(!confirm('Delete prompt?')) return;
    await apiCall('/api/prompts/'+id,{method:'DELETE'});
    loadPrompts();
  }

  /* Drag-and-drop move / copy */
  let draggedPromptId=null;
  function handleDragStart(e,id){ draggedPromptId=id; }
  async function handleDrop(e,targetDir){
    e.preventDefault();
    if(!draggedPromptId) return;
    const copy=e.ctrlKey||e.metaKey;
    await apiCall('/api/prompts/'+draggedPromptId+'/directory',
      {method:'PUT',body:JSON.stringify({directory_id:targetDir,copy})});
    draggedPromptId=null; loadPrompts();
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  MODAL HELPERS  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function showNewPromptModal(){
    promptModalTitle.textContent='New Prompt';
    promptTitle.value=''; promptContent.value=''; promptRestricted.checked=false;
    promptModalSave.onclick=()=>savePrompt();
    promptModal.showModal();
  }
  function showNewFolderModal(){
    folderName.value=''; parentDirectory.value=''; folderShared.checked=false;
    folderModal.showModal();
  }

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  FIRST-LOAD  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  (async()=>{
    if(authToken && currentUser){
      loginModal.close();
      appContainer.classList.remove('hidden');
      userEmail.textContent=currentUser.email;
      await loadDirectories(); await loadPrompts();
    }
  })();
  </script>
</body>
</html>
